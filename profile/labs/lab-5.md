# Лабораторная 5

## Отрабатываемый материал

Реактивное межсервисное взаимодействие, Kafka

## Задача

Интегрировать сервис из Лабораторной 4 с сервисом обработки заказов.

- начать писать в топик `order_creation`
- начать читать топик `order_processing`
- добавить эндпоинты сервиса обработки заказа на гейтвей

Для развертывания сервиса используйте
файл [docker-compose.yaml](https://github.com/is-csms-y26/lab-5-tools/blob/master/docker-compose.yaml), он запускает
контейнер сервиса, его базу, kafka, а также kafka-ui, который вы можете использовать для просмотра сообщений в топиках и
отладки.

Для подключения к kafka вы должны использовать адрес `localhost:8001` если запускаете сервис не в docker контейнере.
Если вы запускаете свой сервис в docker контейнере, то вы должны добавить к нему нетворк
`order-processing-service-network` и использовать адрес `kafka:9094`.

Обратите внимание, что в данном файле, для конфигурации proto контрактов в kafka-ui используется путь относительный в
репозитории самого сервиса. Вам будет необходимо изменить этот путь на корректный для вашего репозитория.

```yaml
kafka-ui:
  # ...
  volumes:
    - ./src/Presentation/Lab5.Tools.Presentation.Kafka/protos:/schemas # change path to your local proto directory, ex: `src/lab-5/Kafka/protos:/schemas`
  # ...
```

Данная лабораторная должна быть реализована в папке `lab-4`, все необходимые модификации должны быть выполнены в
существующем коде. Допускается перенос реализаций сервисов и репозиториев в папку `lab-4`.

### Контракты

Схема топика
`order_creation` – [order_creation.proto](https://github.com/is-csms-y26/lab-5-tools/blob/master/src/Presentation/Lab5.Tools.Presentation.Kafka/protos/order_creation.proto)

Схема топика
`order_processing` – [order_processing.proto](https://github.com/is-csms-y26/lab-5-tools/blob/master/src/Presentation/Lab5.Tools.Presentation.Kafka/protos/order_processing.proto)

Контракты сервиса обработки
заказов – [orders.proto](https://github.com/is-csms-y26/lab-5-tools/blob/master/src/Presentation/Lab5.Tools.Presentation.Grpc/protos/orders.proto)

## Функциональные требования

- Ваш сервис должен читать топик `order_processing` и корректно обрабатывать его события
    - события, подразумевающие неудачный исход, при этом неудачном исходе должны переводить заказ в статус отменён в
      вашем сервисе
    - при получении событий о жизненном цикле заказа, ваш сервис должен записывать данные об этом в историю
- Ваш сервис должен писать в топик `order_creation` корректно обрабатывая свои операции
    - создание заказа должно приводить к записи сообщения об этом
    - перевод заказа в статус `processing` должен приводить к записи сообщения об этом
- Логика отмены заказов вашего сервиса должна быть переработана так, чтобы отмена была возможно только для заказов в
  статусе `created`
- После получения события об успешном завершении доставки заказа – заказ должен оказаться в статусе `completed`
- Вы должны убрать возможность перевести заказ в статус `completed` через ручки вашего сервиса

### Сценарий тестирования

- создание заказа (ваш сервис)
- перевод заказа в статус processing (ваш сервис)
- заказ согласуется* (сервис обработки заказов)
- начало упаковки заказа (сервис обработки заказов)
- завершение упаковки заказа* (сервис обработки заказов)
- начало доставки заказа (сервис обработки заказов)
- завершение доставки заказа* (сервис обработки заказов)

\* Данные операции сервиса обработки заказов могут завершиться неуспешно, ваш сервис должен уметь это обрабатывать.

## Нефункциональные требования

- Вы должны реализовать общие абстракции для записи в топики и чтения из них
    - для producer вы должны выделить интерфейс и реализовать его
    - для consumer вы должны выделить интерфейс обработчика сообщений, а также реализовать фоновый сервис вычитывающий
      сообщения
    - producer и consumer не должны завязываться на конкретные топики, они должны быть реализованы в отдельном проекте,
      должны иметь методы расширения для подключения
    - все параметры работы с kafka (подключение, названия топиков, размеры батчей) должны быть параметризованы через
      options
    - consumer должен реализовывать батчовую обработку сообщений
- В качестве примера реализации producer и consumer вы можете использовать
  библиотеку [Itmo.Dev.Platform.Kafka](https://github.com/itmo-is-dev/platform/tree/master/src/Itmo.Dev.Platform.Kafka)
- Запрещается использовать `Itmo.Dev.Platform.Kafka` в своем коде
- Запрещается полностью копировать реализацию из `Itmo.Dev.Platform.Kafka`
- Эндпоинты HTTP гейтвея, как новые, так и существующие, должны быть реализованы согласно конвенциям REST
