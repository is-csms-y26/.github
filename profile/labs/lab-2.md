# Лабораторная 2

Для каждого задания необходимо создавать отдельный проект в соответствующей solution папке.

## Задание 1

### Отрабатываемый материал

Http, Refit

### Задача

Реализовать клиент для внешнего сервиса конфигураций, позволяющий выгрузку элементов конфигураций.

Реализация стороннего сервиса конфигураций находится в
репозитории [lab-2-tools](https://github.com/is-csms-y26/lab-2-tools), данный сервис заранее собран в Docker образ,
также в репозитории вы можете
найти [docker-compose](https://github.com/is-csms-y26/lab-2-tools/blob/master/docker-compose.yaml) файл, который
разворачивает сам сервис и базу данных для него. Вам необходимо скопировать этот файл в папку `scr/lab-2` вашего
репозитория и добавить его в solution папку `src/lab-2`. Данный сервис имеет Swagger документацию (по пути `/swagger`)
которую вы можете использовать для сидинга данных в сервис.

### Функциональные требования

- Реализация должна содержать [основной] интерфейс, позволяющий выгрузить все конфигурации из сервиса

### Нефункциональные требования

- Вам необходимо сделать две реализации – одну с ручной реализацией запросов, другую с использованием Refit
- Выгрузка конфигураций должна происходить пагинированно
- Основной интерфейс не должен зависеть от Refit
- Размер выгружаемой страницы должен параметризироваться
- В ручной реализации `HttpClient` должен получаться при помощи `IHttpClientFactory`
- Реализация должна содержать экстеншен методы для регистрации в DI обеих реализаций (два отдельных метода)

## Задание 2

### Отрабатываемый материал

Microsoft.Extensions.Configuration, ConfigurationProvider

### Задача

Реализовать кастомный ConfigurationProvider, который будет получать и отдавать конфигурации из сервиса Задания 1.

### Нефункциональные требования

- Вам необходимо реализовать сервис, обслуживающий провайдер, получающий конфигурации из клиента и отправляющий их в
  провайдер на обработку
- Сам провайдер не должен реализовывать какие-либо походы в клиенты
- Обслуживающий сервис должен предоставлять метод, обновляющий конфигурации раз в какой-то промежуток (для этого можно
  использовать класс PeriodicTimer)
- Промежуток обновления конфигураций должен быть параметризуем
- Провайдер не должен перезагружать конфигурации, если в них не было изменений

### Тестовые сценарии

#### Сценарий 1

**Arrange**: провайдер не имеет каких-либо ключей конфигураций
**Act**: провайдеру передают элемент конфигурации
**Assert**: провайдер содержит единственную пару ключ-значение, соответсвующую переданному элементу и обновляет
конфигурацию

#### Сценарий 2

**Arrange**: провайдер содержит единственную пару ключ-значение
**Act**: провайдеру передают такой же элемент конфигурации
**Assert**: провайдер не вызвал обновление конфигурации

#### Сценарий 3

**Arrange**: провайдер содержит единственную пару ключ-значение
**Act**: провайдеру передают элемент с таким же ключом, но изменённым значением
**Assert**: провайдер обновляет значение по ключу, и обновляет конфигурацию

#### Сценарий 4

**Arrange**: провайдер содержит единственную пару ключ-значение
**Act**: провайдеру передают пустую коллекцию конфигураций
**Assert**: провайдер становится пустым и обновляет конфигурацию

> для проверок того, обновил ли провайдер конфигурацию, вы можете посмотреть реализацию метода `OnReload` и какие данные
> он меняет

## Задание 3

### Отрабатываемый материал

Npgsql, Postgres, serialization, options

### Задание

Реализовать репозитории, миграцию и сервис для предоставленной [схемы данных](lab-2-task-3.sql).

### Функциональные требования

- Репозиторий товаров должен предоставлять функционал
    - Создания товаров
    - Пагинированного поиска товаров (фильтрация по: идентификаторам, минимальной и максимальной цене, подстроке в имени
      товара)
- Репозиторий заказов должен предоставлять функционал
    - Создания заказа
    - Изменения статуса заказа
    - Пагинированного поиска заказов (фильтрация по: идентификаторам, статусу, автору)
- Репозиторий позиций заказов должен предоставлять функционал
    - Добавление позиции заказа
    - Удаление позиции из заказа (soft delete)
    - Пагинированного поиска по позициям заказов (фильтрация по: идентификаторам заказов, идентификаторам товаров,
      признаку удаления [bool?])
- Репозиторий истории заказов должен предоставлять функционал
    - Добавление записи в историю заказа
    - Пагинированного поиска по истории заказов (фильтрация по: идентификаторам заказа, типу истории)
- Сервис товаров должен предоставлять функционал
    - Создания товаров
- Сервис заказов должен предоставлять функционал
    - Создания заказа
    - Добавления товаров в заказ (только для заказов в статусе `created`)
    - Удаление товаров из заказа (только для заказов в статусе `created`)
    - Перевод заказа в работу (статус `processing`)
    - Выполнение заказа (перевод в статус `completed`)
    - Отмену заказа (перевод в статус `cancelled`)
    - Пагинированного поиска по истории одного заказа
    - Все операции должны сопровождаться соответствующими записями в историю

### Нефункциональные требования

- Миграции должны быть реализованы через библиотеку FluentMigrator и SQL код
- Конфигурации базы данных должны быть получены через Microsoft.Extensions.Options
- Должны быть реализованы методы расширения для регистрации в DI миграций, репозиториев и подключений к базе данных
- Должен быть реализованы методы расширения для запуска миграций
- В репозитории истории заказов должна быть реализована полиморфная сериализация/десериализация записей истории
- Репозитории должны быть реализованы через SQL запросы и библиотеку Npgsql
- Операции сервиса, подразумевающие несколько запросов в базу данных, должны использовать транзакции
- Должен быть реализован метод расширения для регистрации сервисов в DI
- Конфигурация базы данных должна получаться из провайдера, реализованного в Задании 2

### Тестовые сценарии

В качестве тестового сценария реализуйте отдельное консольное приложение, собирающее ServiceCollection с реализованными
ранее сервисами, подключенной конфигурацией внешнего сервиса. Данные для подключения внешнего сервиса конфигураций
должны находится в JSON файле, также подключаемым в конфигурации.

Проект с данным сценарием должен находиться в solution папке тестов.

Для вашего сценария должна использоваться **отдельная** база данных (не та, что использует сервис конфигураций), для
этого вам будет необходимо добавить в docker compose файл ещё один сервис с базой данных.

Сценарий подразумевает

- Загрузку конфигураций через обслуживающий сервис
- Создание нескольких товаров
- Создание заказа
- Добавления товаров в заказ
- Удаление одного товара из заказа
- Перевод заказа в работу
- Выполнение заказа
- Вывод в консоль всей истории заказа

Работоспособность данного сценария вам необходимо будет продемонстрировать преподавателю на защите лабораторной.